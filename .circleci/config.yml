version: 2
jobs:
  build:
    macos:
      xcode: "9.2.0"
    working_directory: ~/edx-app-ios
    environment:
      XCODE_WORKSPACE: edX.xcworkspace
      XCODE_SCHEME: edX
      LC_ALL: en_US.UTF-8
      LANG: en_US.UTF-8
      TERM: dumb

    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            sudo pip install requests
            brew update
            brew upgrade openssl
            brew install ruby
            brew install imagemagick
            brew cleanup
            sudo gem install fastlane
            ./gradlew dependencies --stacktrace --info
      - run:
          name: Download app resources
          command: |
            git clone git@github.com:proversity-org/houston-ios-config.git --branch no-branch --single-branch ./deployment
            cp -R deployment/custom_config custom_config
            cp -R deployment/default_config/ default_config
            cp -R deployment/fastlane fastlane
            cp -R deployment/setup.py setup.py
      - run:
          name: Deploy to Testflight
          command: |
            python setup.py
            fastlane beta
workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build:
          filters:
            branches:
              only: no-branch